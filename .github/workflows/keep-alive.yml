name: Keep App Alive

on:
  schedule:
    # Run every 12 hours to prevent Streamlit Cloud from sleeping
    # Streamlit Cloud apps sleep after ~7 days of inactivity
    - cron: '0 */12 * * *'  # At minute 0 of every 12th hour
  workflow_dispatch:  # Allow manual triggering

jobs:
  wake-up:
    runs-on: ubuntu-latest

    steps:
      - name: Wake up Streamlit app
        run: |
          echo "üîÑ Waking up Streamlit Cloud app..."

          # First request - wake up the app (may timeout, that's expected)
          curl -sSf --max-time 120 \
            -H "User-Agent: GitHub-Actions-KeepAlive" \
            -o /dev/null \
            "${{ secrets.STREAMLIT_APP_URL }}" || echo "Initial wake-up request sent (timeout expected)"

          # Wait for app to fully spin up
          echo "‚è≥ Waiting 30 seconds for app to initialize..."
          sleep 30

          # Second request - verify app is responding
          echo "‚úÖ Verifying app is awake..."
          HTTP_STATUS=$(curl -sSf --max-time 60 \
            -H "User-Agent: GitHub-Actions-KeepAlive" \
            -w "%{http_code}" \
            -o /dev/null \
            "${{ secrets.STREAMLIT_APP_URL }}" || echo "000")

          if [ "$HTTP_STATUS" = "200" ]; then
            echo "‚úÖ App is awake and responding (HTTP $HTTP_STATUS)"
          else
            echo "‚ö†Ô∏è App responded with HTTP $HTTP_STATUS (may still be waking up)"
          fi

          echo "üéâ Keep-alive job completed at $(date -u)"

      - name: Notify on failure
        if: failure()
        run: |
          echo "‚ùå Failed to wake up the Streamlit app"
          echo "Please check if STREAMLIT_APP_URL secret is configured correctly"
